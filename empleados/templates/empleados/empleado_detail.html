{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
       <a href="{% url 'empleados:list' %}" class="text-decoration-none text-muted mb-1 d-block"><i class="bi bi-arrow-left"></i> Volver a lista</a>
       <h2 class="mb-0">
          {% if obj.foto %}
            <img src="{{ obj.foto.url }}" class="rounded-circle me-2" style="width: 50px; height: 50px; object-fit: cover;">
          {% else %}
            <i class="bi bi-person-circle text-secondary me-2"></i>
          {% endif %}
          {{ obj.nombre_completo }} 
          {% if not obj.activo %}<span class="badge bg-danger fs-6 align-middle ms-2">Inactivo</span>{% endif %}
       </h2>
       <div class="text-muted small ms-5">{{ obj.puesto }} - {{ obj.departamento }}</div>
    </div>
    <div class="d-flex gap-2">
      <a href="{% url 'empleados:editar' obj.pk %}" class="btn btn-outline-primary">
        <i class="bi bi-pencil"></i> Editar
      </a>
    </div>
  </div>

  <div class="row">
    <!-- INFO COLUMN -->
    <div class="col-md-4 mb-3">
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-white fw-bold">Detalles</div>
        <div class="list-group list-group-flush">
          <div class="list-group-item">
            <small class="text-muted d-block">Número Nómina</small>
            {{ obj.numero }}
          </div>
          <div class="list-group-item">
            <small class="text-muted d-block">Documento ID</small>
            {{ obj.doc_id }}
          </div>
          <div class="list-group-item">
             <small class="text-muted d-block">Vinculación</small>
             {{ obj.get_tipo_vinculacion_display }}
          </div>
          <div class="list-group-item">
            <small class="text-muted d-block">Contacto</small>
            <div><i class="bi bi-telephone me-1"></i> {{ obj.telefono|default:"--"}}</div>
            <div><i class="bi bi-envelope me-1"></i> {{ obj.email|default:"--"}}</div>
            <div class="small text-muted mt-1">{{ obj.direccion|default:"" }}</div>
          </div>
        </div>
      </div>

       <div class="card shadow-sm border-0 border-top border-primary border-4">
          <div class="card-body">
             <div class="d-flex justify-content-between align-items-center mb-2">
                 <h6 class="card-title text-primary m-0"><i class="bi bi-hdd-network me-2"></i>Dispositivos Vinculados</h6>
                 <a href="{% url 'empleados:vincular' obj.pk %}" class="btn btn-sm btn-outline-primary" title="Vincular Dispositivo"><i class="bi bi-link-45deg"></i></a>
             </div>
             
             {% if obj.usuarios_dispositivo.exists %}
                 <ul class="list-group list-group-flush">
                 {% for ud in obj.usuarios_dispositivo.all %}
                     <li class="list-group-item px-0 py-2 d-flex justify-content-between align-items-center">
                        <div>
                             <div class="fw-bold">{{ ud.dispositivo.nombre }}</div>
                             <div class="small text-muted">
                                 <span title="User ID">ID: {{ ud.user_id }}</span> 
                                 {% if ud.uid %}<span class="mx-1">|</span> UID: {{ ud.uid }}{% endif %}
                             </div>
                        </div>
                        <form action="{% url 'empleados:desvincular' ud.pk %}" method="post" onsubmit="return confirm('¿Desvincular este dispositivo?')">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm text-danger border-0 bg-transparent p-0" title="Desvincular">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                     </li>
                 {% endfor %}
                 </ul>
             {% else %}
                 <p class="text-muted fst-italic small mb-0">No vinculado a ningún dispositivo.</p>
                 <a href="{% url 'empleados:vincular' obj.pk %}" class="btn btn-sm btn-outline-dark mt-2 w-100">Vincular ahora</a>
             {% endif %}
          </div>
       </div>

            <!-- BAJAS AUTORIZADAS -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 fw-bold text-primary"><i class="bi bi-calendar-check me-2"></i>Bajas Autorizadas</h6>
                    <a href="{% url 'empleados:baja_crear' obj.pk %}" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus-circle me-1"></i>Registrar Baja
                    </a>
                </div>
                <div class="card-body">
                    {% if bajas %}
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Fecha Inicio</th>
                                        <th>Fecha Fin</th>
                                        <th>Tipo</th>
                                        <th>Descripción</th>
                                        <th class="text-end">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for baja in bajas %}
                                    <tr>
                                        <td>{{ baja.fecha_inicio|date:"d/m/Y" }}</td>
                                        <td>{{ baja.fecha_fin|date:"d/m/Y" }}</td>
                                        <td>
                                            <span class="badge {% if baja.tipo == 'VACA' %}bg-info{% elif baja.tipo == 'ENFE' %}bg-danger{% else %}bg-secondary{% endif %}">
                                                {{ baja.get_tipo_display }}
                                            </span>
                                        </td>
                                        <td>{{ baja.descripcion|truncatechars:30 }}</td>
                                        <td class="text-end">
                                            <form action="{% url 'empleados:baja_eliminar' baja.pk %}" method="post" class="d-inline" onsubmit="return confirm('¿Borrar esta baja autorizada?')">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-outline-danger border-0">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-calendar-x fs-1 text-muted opacity-50 d-block mb-3"></i>
                            <p class="text-muted mb-0">No hay bajas autorizadas registradas.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

    </div>

    <!-- DOCUMENTOS COLUMN -->
    <div class="col-md-8">
      <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-expediente">Expediente Digital</button>
        </li>
      </ul>

      <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-expediente">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <h5 class="mb-0"><i class="bi bi-folder2-open me-2"></i>Documentos Adjuntos</h5>
                  <button class="btn btn-sm btn-outline-dark" data-bs-toggle="modal" data-bs-target="#uploadModalEmp">
                    <i class="bi bi-cloud-arrow-up me-1"></i>Subir Documento
                  </button>
                </div>
                <div class="card-body p-0">
                  <table class="table table-hover mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>Tipo</th>
                        <th>Descripción</th>
                        <th>Fecha</th>
                        <th class="text-end">Acciones</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for d in documentos %}
                      <tr>
                        <td><span class="badge bg-light text-dark border">{{ d.get_tipo_display }}</span></td>
                        <td>{{ d.descripcion }}</td>
                        <td>{{ d.subido_en|date:"d/m/Y H:i" }}</td>
                        <td class="text-end">
                           <a href="{{ d.archivo.url }}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-download"></i></a>
                           <a href="{% url 'empleados:doc_eliminar' d.pk %}" class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Eliminar archivo?')"><i class="bi bi-trash"></i></a>
                        </td>
                      </tr>
                      {% empty %}
                      <tr><td colspan="4" class="text-center py-4 text-muted">No hay documentos adjuntos.</td></tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Upload -->
<div class="modal fade" id="uploadModalEmp" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" enctype="multipart/form-data" action="{% url 'empleados:doc_subir_empleado' obj.pk %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Subir Documento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
           <div class="mb-3">
             <label class="form-label">Tipo</label>
             {{ doc_form.tipo }}
           </div>
           <div class="mb-3">
             <label class="form-label">Descripción</label>
             {{ doc_form.descripcion }}
           </div>
           <div class="mb-3">
             <label class="form-label">Archivo</label>
             {{ doc_form.archivo }}
           </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button type="submit" class="btn btn-primary">Subir</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
