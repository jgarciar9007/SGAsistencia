{% extends "base.html" %}
{% load humanize %}
{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1 text-gray-800">Previsualización de Nómina</h1>
            <p class="text-muted mb-0">Periodo: <strong>{{ inicio|date:"d/m/Y" }}</strong> al <strong>{{ fin|date:"d/m/Y" }}</strong></p>
        </div>
        <div>
            <a href="{% url 'reportes:nomina_calculo_form' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> Volver a parámetros
            </a>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white py-3">
            <h6 class="m-0 fw-bold text-primary"><i class="bi bi-table me-2"></i>Edición de Conceptos Salariales</h6>
        </div>
        <div class="card-body p-0">
            <form action="{% url 'reportes:nomina_guardar' %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="inicio" value="{{ inicio|date:'Y-m-d' }}">
                <input type="hidden" name="fin" value="{{ fin|date:'Y-m-d' }}">

                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="payrollTable">
                        <thead class="table-light">
                            <tr>
                                <th>Empleado</th>
                                <th style="width: 120px;">S. Base</th>
                                <th style="width: 80px;">Aus.</th>
                                <th style="width: 110px;">Desc. Aus.</th>
                                <th style="width: 110px;">Bonos</th>
                                <th style="width: 110px;">Otros Inc.</th>
                                <th style="width: 110px;">Desc. Ext.</th>
                                <th style="width: 110px;">Impuestos</th>
                                <th class="text-end" style="width: 140px;">Neto Pagar</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in rows %}
                            <tr data-emp-id="{{ r.id }}">
                                <td>
                                    <input type="hidden" name="emp_id" value="{{ r.id }}">
                                    <div class="fw-bold text-dark">{{ r.nombre }}</div>
                                    <div class="small text-muted text-uppercase">{{ r.departamento }}</div>
                                </td>
                                <td>
                                    <input type="text" name="salario_base_{{ r.id }}" class="form-control form-control-sm text-end input-calc" value="{{ r.salario_base|floatformat:0|intcomma }}" readonly>
                                </td>
                                <td>
                                    <input type="number" name="ausencias_{{ r.id }}" class="form-control form-control-sm text-center input-aus" value="{{ r.ausencias }}" readonly>
                                </td>
                                <td>
                                    <input type="text" name="descuento_ausencia_{{ r.id }}" class="form-control form-control-sm text-end input-calc" value="{{ r.descuento|floatformat:0|intcomma }}" readonly>
                                </td>
                                <td>
                                    <input type="text" name="bonos_{{ r.id }}" class="form-control form-control-sm text-end input-calc input-edit" value="0">
                                </td>
                                <td>
                                    <input type="text" name="otros_{{ r.id }}" class="form-control form-control-sm text-end input-calc input-edit" value="0">
                                </td>
                                <td>
                                    <input type="text" name="desc_{{ r.id }}" class="form-control form-control-sm text-end input-calc input-edit" value="0">
                                </td>
                                <td>
                                    <input type="text" name="imp_{{ r.id }}" class="form-control form-control-sm text-end input-calc input-edit" value="0">
                                </td>
                                <td class="text-end fw-bold text-primary">
                                    <span class="neto-span" id="neto_{{ r.id }}">{{ r.neto|floatformat:0|intcomma }} FCFA</span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="9" class="text-center py-5">
                                    <i class="bi bi-people fs-1 text-muted opacity-50 d-block mb-3"></i>
                                    <p class="text-muted">No se encontraron empleados activos con salario base configurado.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="card-footer bg-white py-3 text-end">
                    <button type="submit" class="btn btn-primary px-4">
                        <i class="bi bi-check-circle me-1"></i> Guardar y Finalizar Nómina
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Función para parsear "1.000.000" -> 1000000
        function parseLocaleNumber(stringNumber) {
            if (!stringNumber) return 0;
            // Quitamos puntos, espacios (normales y NO-BREAK SPACE), 'FCFA'
            var clean = stringNumber.toString().replace(/\./g, '')
                                     .replace(/\s/g, '')
                                     .replace(/\u00a0/g, '')
                                     .replace(/FCFA/g, '')
                                     .replace(/,/g, '.'); 
            return parseFloat(clean) || 0;
        }

        // Función para formatear 1000000 -> "1.000.000"
        function formatLocaleNumber(num) {
            // Usamos formato alemán (puntos para miles, coma para decimal, aunque forzamos entero)
            return Math.round(num).toLocaleString('de-DE');
        }

        // Manejo de inputs editables
        const inputs = document.querySelectorAll('.input-calc');
        
        inputs.forEach(input => {
            // Al enfocar, si es editable, seleccionamos todo
            input.addEventListener('focus', function() {
                if (!this.readOnly) this.select();
            });

            // Al escribir: formatear en tiempo real (solo para editables)
            input.addEventListener('input', function() {
                // Si es editable, formateamos el valor visualmente
                if (this.classList.contains('input-edit')) {
                    // Guardar posición del cursor para UX (opcional, simple replace mueve cursor a veces)
                    let val = this.value.replace(/\D/g, ''); // Solo números
                    if (val === "") {
                         this.value = "";
                    } else {
                         let num = parseInt(val, 10);
                         this.value = formatLocaleNumber(num);
                    }
                }
                recalcRow(this.closest('tr'));
            });
        });

        function recalcRow(tr) {
            const empId = tr.getAttribute('data-emp-id');
            
            const salBase = parseLocaleNumber(tr.querySelector(`[name="salario_base_${empId}"]`).value);
            const descAus = parseLocaleNumber(tr.querySelector(`[name="descuento_ausencia_${empId}"]`).value);
            
            const bonos = parseLocaleNumber(tr.querySelector(`[name="bonos_${empId}"]`).value);
            const otros = parseLocaleNumber(tr.querySelector(`[name="otros_${empId}"]`).value);
            const desc = parseLocaleNumber(tr.querySelector(`[name="desc_${empId}"]`).value);
            const imp = parseLocaleNumber(tr.querySelector(`[name="imp_${empId}"]`).value);
            
            const neto = (salBase + bonos + otros) - (descAus + desc + imp);
            
            document.getElementById(`neto_${empId}`).textContent = formatLocaleNumber(neto) + " FCFA";
        }
    });
</script>

<style>
    .input-calc:read-only {
        background-color: #f8f9fa;
        cursor: not-allowed;
        border: none;
        box-shadow: none;
        font-weight: 500;
    }
    /* Alinear las tablas bien */
    .table-hover tbody tr:hover {
        background-color: rgba(0,0,0,.02);
    }
    .form-control-sm {
        border-color: #d1d3e2;
    }
    .form-control-sm:focus {
        border-color: #4e73df;
        box-shadow: 0 0 0 0.2rem rgba(78,115,223,.25);
    }
</style>
{% endblock %}
